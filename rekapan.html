<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rekapan Data Posyandu - NutriKids</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <style>
        body { font-family: "Poppins", sans-serif; background-color: #f1f5f9; }
        .glass-card { background: white; border-radius: 1.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .table-header { color: #64748b; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; }
    </style>
</head>
<body class="pb-20">
    <nav class="bg-white py-4 px-10 flex justify-between items-center shadow-md sticky top-0 z-50">
        <h1 class="text-2xl font-black text-blue-600">Nutri<span class="text-emerald-500">Kids</span></h1>
        <div class="flex gap-3">
            <a href="hasil.html" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-5 py-2 rounded-2xl text-sm font-bold transition">Kembali</a>
            <a href="inputData.html" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-5 py-2 rounded-2xl text-sm font-bold transition">Input Data</a>
            <a href="index.html" class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-2 rounded-2xl text-sm font-bold transition shadow-lg shadow-blue-200">Keluar</a>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-6 mt-10">
        <div class="text-center mb-10">
            <h2 class="text-3xl font-black text-slate-800">Rekapan Data Posyandu</h2>
            <p class="text-slate-500 text-sm mt-2">Menampilkan semua riwayat pemeriksaan Si Kecil.</p>
        </div>

        <div class="glass-card p-6 mb-8 border-none ring-1 ring-slate-200">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="md:col-span-2 relative">
                    <span class="absolute left-4 top-4 text-slate-400">üîç</span>
                    <input type="text" id="searchBox" onkeyup="renderTable()" placeholder="Cari Posyandu atau Nama Anak..." 
                        class="w-full pl-12 pr-4 py-4 rounded-xl bg-slate-50 border-none focus:ring-2 focus:ring-blue-400 outline-none font-bold text-slate-700 shadow-inner" />
                </div>
                
                <select id="filterBulan" onchange="renderTable()" class="py-4 px-4 rounded-xl bg-slate-50 border-none font-bold text-slate-600 outline-none focus:ring-2 focus:ring-blue-400 shadow-inner">
                    <option value="">Semua Bulan</option>
                    <option value="01">Januari</option><option value="02">Februari</option>
                    <option value="03">Maret</option><option value="04">April</option>
                    <option value="05">Mei</option><option value="06">Juni</option>
                    <option value="07">Juli</option><option value="08">Agustus</option>
                    <option value="09">September</option><option value="10">Oktober</option>
                    <option value="11">November</option><option value="12">Desember</option>
                </select>

                <select id="filterTahun" onchange="renderTable()" class="py-4 px-4 rounded-xl bg-slate-50 border-none font-bold text-slate-600 outline-none focus:ring-2 focus:ring-blue-400 shadow-inner">
                    <option value="">Semua Tahun</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                </select>
            </div>
        </div>

        <div class="glass-card overflow-hidden border-none ring-1 ring-slate-200">
            <div id="tableContainer" class="hidden overflow-x-auto">
                <table class="w-full text-left" id="rekapanTable">
                    <thead class="bg-slate-50 border-b border-slate-100">
                        <tr>
                            <th class="p-6 table-header text-center">Tanggal</th>
                            <th class="p-6 table-header">Nama Posyandu</th>
                            <th class="p-6 table-header">Nama Anak</th>
                            <th class="p-6 table-header text-center">BB / TB</th>
                            <th class="p-6 table-header text-center">Status Gizi</th>
                            <th class="p-6 table-header text-center">Hapus</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-50 font-bold text-slate-600 text-sm"></tbody>
                </table>
            </div>

            <div id="emptyState" class="py-32 text-center">
                <div class="text-6xl mb-4">üìÇ</div>
                <p class="text-slate-500 font-extrabold text-lg">Belum Ada Data</p>
                <p class="text-slate-400 text-sm mt-1 uppercase tracking-widest">Silakan isi data di kalkulator terlebih dahulu</p>
            </div>
        </div>

        <div class="mt-8 flex flex-col md:flex-row justify-between items-center gap-4">
            <button onclick="clearAllData()" class="text-red-400 hover:text-red-600 font-bold text-xs px-4 py-2 rounded-lg hover:bg-red-50 transition">
                üóëÔ∏è RESET SEMUA REKAPAN
            </button>
            <button onclick="exportToExcel()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-10 py-5 rounded-2xl font-black shadow-xl transition-all flex items-center gap-3">
                üìó DOWNLOAD EXCEL
            </button>
        </div>
    </main>

    <script>
        function renderTable() {
            // 1. Ambil data hasil pemeriksaan
            const allData = JSON.parse(localStorage.getItem("allNutriResults")) || [];
            // 2. Ambil profil posyandu (Untuk cadangan jika di data pemeriksaan tidak ada namanya)
            const dataP = JSON.parse(localStorage.getItem("dataPosyandu")) || {};
            
            const query = document.getElementById("searchBox").value.toLowerCase().trim();
            const filterBulan = document.getElementById("filterBulan").value;
            const filterTahun = document.getElementById("filterTahun").value;
            
            const tableBody = document.getElementById("tableBody");
            const emptyState = document.getElementById("emptyState");
            const tableContainer = document.getElementById("tableContainer");

            tableBody.innerHTML = "";

            const filteredData = allData.filter((item) => {
                // PENYEMPURNAAN: Prioritaskan nama dari item, lalu dari profil posyandu, terakhir baru "UMUM"
                const namaP = (item.namaPosyandu || item.posyandu || dataP.posyandu || "UMUM").toLowerCase();
                const namaA = (item.namaAnak || "").toLowerCase();
                const tgl = item.tanggal || "";
                
                const parts = tgl.split('/');
                const bln = parts[1] || ""; 
                const thn = parts[2] || "";

                const matchSearch = namaP.includes(query) || namaA.includes(query);
                const matchBulan = filterBulan === "" || bln === filterBulan;
                const matchTahun = filterTahun === "" || thn === filterTahun;

                return matchSearch && matchBulan && matchTahun;
            });

            if (filteredData.length > 0) {
                emptyState.classList.add("hidden");
                tableContainer.classList.remove("hidden");
                
                filteredData.reverse().forEach((item) => {
                    // Tentukan nama posyandu yang akan ditampilkan
                    const displayPosyandu = item.namaPosyandu || item.posyandu || dataP.posyandu || "UMUM";
                    const id = item.timestamp;

                    tableBody.innerHTML += `
                        <tr class="hover:bg-blue-50/50 transition border-b border-slate-50">
                            <td class="p-6 text-center">
                                <div class="text-slate-800">${item.tanggal || '-'}</div>
                                <div class="text-[10px] text-blue-400 mt-1 uppercase font-black">Jam ${item.jam || '-'}</div>
                            </td>
                            <td class="p-6 text-blue-600 font-extrabold uppercase">${displayPosyandu}</td>
                            <td class="p-6 text-slate-800">${item.namaAnak || '-'}</td>
                            <td class="p-6 text-center">
                                <span class="bg-slate-100 px-2 py-1 rounded-md text-slate-700">${item.bb || 0}kg / ${item.tb || 0}cm</span>
                            </td>
                            <td class="p-6 text-center">
                                <span class="px-4 py-2 rounded-full text-[10px] font-black uppercase inline-block border shadow-sm" 
                                    style="background: ${item.color}15; color: ${item.color}; border-color: ${item.color}40">
                                    ${item.status || 'NORMAL'}
                                </span>
                            </td>
                            <td class="p-6 text-center">
                                <button onclick="deleteRow('${id}')" class="text-red-400 hover:text-red-600 p-2 bg-red-50 rounded-xl transition">
                                    üóëÔ∏è
                                </button>
                            </td>
                        </tr>`;
                });
            } else {
                emptyState.classList.remove("hidden");
                tableContainer.classList.add("hidden");
            }
        }

        function deleteRow(id) {
            if (confirm("Hapus data ini?")) {
                let allData = JSON.parse(localStorage.getItem("allNutriResults")) || [];
                const newData = allData.filter(item => item.timestamp.toString() !== id.toString());
                localStorage.setItem("allNutriResults", JSON.stringify(newData));
                renderTable();
            }
        }

        function clearAllData() {
            if (confirm("Hapus seluruh rekapan secara permanen?")) {
                localStorage.removeItem("allNutriResults");
                renderTable();
            }
        }

        function exportToExcel() {
            const table = document.getElementById("rekapanTable");
            const wb = XLSX.utils.table_to_book(table);
            XLSX.writeFile(wb, "Rekapan_NutriKids.xlsx");
        }

        window.onload = renderTable;
    </script>
</body>
</html>